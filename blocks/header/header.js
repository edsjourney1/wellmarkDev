import{fetchPlaceholders,getMetadata}from"../../scripts/aem.js";import{loadFragment}from"../fragment/fragment.js";let isDesktop=window.matchMedia("(min-width: 900px)");function closeOnEscape(e){var t,a;"Escape"===e.code&&((a=(t=(e=document.getElementById("nav")).querySelector(".nav-sections")).querySelector('[aria-expanded="true"]'))&&isDesktop.matches?(toggleAllNavSections(t),a.focus()):isDesktop.matches||(toggleMenu(e,t),e.querySelector("button").focus()))}function closeOnFocusLost(e){var t=e.currentTarget;t.contains(e.relatedTarget)||((e=t.querySelector(".nav-sections")).querySelector('[aria-expanded="true"]')&&isDesktop.matches?toggleAllNavSections(e,!1):isDesktop.matches||toggleMenu(t,e,!1))}function openOnKeydown(e){var t=document.activeElement;"nav-drop"===t.className&&("Enter"===e.code||"Space"===e.code)&&(e="true"===t.getAttribute("aria-expanded"),toggleAllNavSections(t.closest(".nav-sections")),t.setAttribute("aria-expanded",e?"false":"true"))}function focusNavSection(){document.activeElement.addEventListener("keydown",openOnKeydown)}function toggleAllNavSections(e,t=!1){e.querySelectorAll(".nav-sections .default-content-wrapper > ul > li").forEach(e=>{e.setAttribute("aria-expanded",t)})}function toggleMenu(e,t,a=null){var a=null!==a?!a:"true"===e.getAttribute("aria-expanded"),n=e.querySelector(".nav-hamburger button"),n=(document.body.style.overflowY=a||isDesktop.matches?"":"hidden",e.setAttribute("aria-expanded",a?"false":"true"),toggleAllNavSections(t,a||isDesktop.matches?"false":"true"),n.setAttribute("aria-label",a?"Open navigation":"Close navigation"),t.querySelectorAll(".nav-drop"));isDesktop.matches?n.forEach(e=>{e.hasAttribute("tabindex")||(e.setAttribute("tabindex",0),e.addEventListener("focus",focusNavSection))}):n.forEach(e=>{e.removeAttribute("tabindex"),e.removeEventListener("focus",focusNavSection)}),!a||isDesktop.matches?(window.addEventListener("keydown",closeOnEscape),e.addEventListener("focusout",closeOnFocusLost)):(window.removeEventListener("keydown",closeOnEscape),e.removeEventListener("focusout",closeOnFocusLost))}function getDirectTextContent(e){var t=e.querySelector(":scope > a");return t?t.textContent.trim():Array.from(e.childNodes).filter(e=>e.nodeType===Node.TEXT_NODE).map(e=>e.textContent).join(" ")}async function buildBreadcrumbsFromNavTree(e,t){var a=[],n=document.querySelector(".nav-brand a[href]").href;let r=Array.from(e.querySelectorAll("a")).find(e=>e.href===t);if(r)do{var o=r.querySelector(":scope > a");a.unshift({title:getDirectTextContent(r),url:o?o.href:null}),r=r.closest("ul")?.closest("li")}while(r);else t!==n&&a.unshift({title:getMetadata("og:title"),url:t});e=(await fetchPlaceholders()).breadcrumbsHomeLabel||"Home";return a.unshift({title:e,url:n}),1<a.length&&(a[a.length-1].url=null),a[a.length-1]["aria-current"]="page",a}async function buildBreadcrumbs(){var e=document.createElement("nav"),t=(e.className="breadcrumbs",await buildBreadcrumbsFromNavTree(document.querySelector(".nav-sections"),document.location.href)),a=document.createElement("ol");return a.append(...t.map(e=>{var t,a=document.createElement("li");return e["aria-current"]&&a.setAttribute("aria-current",e["aria-current"]),e.url?((t=document.createElement("a")).href=e.url,t.textContent=e.title,a.append(t)):a.textContent=e.title,a})),e.append(a),e}export default async function decorate(e){var t=getMetadata("nav"),t=t?new URL(t,window.location).pathname:"/nav",a=await loadFragment(t);e.textContent="";let n=document.createElement("nav");for(n.id="nav";a.firstElementChild;)n.append(a.firstElementChild);["brand","sections","tools"].forEach((e,t)=>{t=n.children[t];t&&t.classList.add("nav-"+e)});t=n.querySelector(".nav-brand").querySelector(".button");t&&(t.className="",t.closest(".button-container").className="");let r=n.querySelector(".nav-sections");r&&r.querySelectorAll(":scope .default-content-wrapper > ul > li").forEach(t=>{t.querySelector("ul")&&t.classList.add("nav-drop"),t.addEventListener("click",()=>{var e;isDesktop.matches&&(e="true"===t.getAttribute("aria-expanded"),toggleAllNavSections(r),t.setAttribute("aria-expanded",e?"false":"true"))})});t=n.querySelector(".nav-tools"),t&&(t=t.querySelector('a[href*="search"]'))&&""===t.textContent&&t.setAttribute("aria-label","Search"),t=document.createElement("div"),t.classList.add("nav-hamburger"),t.innerHTML=`<button type="button" aria-controls="nav" aria-label="Open navigation">
      <span class="nav-hamburger-icon"></span>
    </button>`,t.addEventListener("click",()=>toggleMenu(n,r)),n.prepend(t),n.setAttribute("aria-expanded","false"),toggleMenu(n,r,isDesktop.matches),isDesktop.addEventListener("change",()=>toggleMenu(n,r,isDesktop.matches)),t=document.createElement("div");t.className="nav-wrapper",t.append(n),e.append(t),"true"===getMetadata("breadcrumbs").toLowerCase()&&t.append(await buildBreadcrumbs())}