import createField from"./form-fields.js";async function createForm(e,t){e=new URL(e).pathname,e=await(await fetch(e)).json();let a=document.createElement("form");return a.dataset.action=t,(await Promise.all(e.data.map(e=>createField(e,a)))).forEach(e=>{e&&a.append(e)}),a.querySelectorAll("fieldset").forEach(t=>{a.querySelectorAll(`[data-fieldset="${t.name}"`).forEach(e=>{t.append(e)})}),a}function generatePayload(e){let t={};return[...e.elements].forEach(e=>{e.name&&"submit"!==e.type&&!e.disabled&&("radio"===e.type?e.checked&&(t[e.name]=e.value):"checkbox"===e.type?e.checked&&(t[e.name]=t[e.name]?t[e.name]+","+e.value:e.value):t[e.name]=e.value)}),t}async function handleSubmit(e){if("true"!==e.getAttribute("data-submitting")){var t=e.querySelector('button[type="submit"]');try{e.setAttribute("data-submitting","true"),t.disabled=!0;var a,i=generatePayload(e),n=await fetch(e.dataset.action,{method:"POST",body:JSON.stringify({data:i}),headers:{"Content-Type":"application/json"}});if(!n.ok)throw a=await n.text(),new Error(a);e.dataset.confirmation&&(window.location.href=e.dataset.confirmation)}catch(e){console.error(e)}finally{e.setAttribute("data-submitting","false"),t.disabled=!1}}}export default async function decorate(e){var a=[...e.querySelectorAll("a")].map(e=>e.href);let i=a.find(e=>e.startsWith(window.location.origin)&&e.endsWith(".json"));a=a.find(e=>e!==i);if(i&&a){let t=await createForm(i,a);e.replaceChildren(t),t.addEventListener("submit",e=>{e.preventDefault(),t.checkValidity()?handleSubmit(t):(e=t.querySelector(":invalid:not(fieldset)"))&&(e.focus(),e.scrollIntoView({behavior:"smooth"}))})}}